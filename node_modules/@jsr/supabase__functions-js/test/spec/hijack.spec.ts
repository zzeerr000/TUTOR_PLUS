import './jest'
import { nanoid } from 'npm:nanoid@^3.3.1'
import { sign } from './jsonwebtoken'

import { FunctionsClient } from '../../src/index.ts'

import { Relay, runRelay } from '../relay/container.ts'
import { attach, log } from '../utils/jest-custom-reporter.ts'

describe('hijack connection', () => {
  let relay: Relay
  const jwtSecret = nanoid(10)
  const apiKey = sign({ name: 'anon' }, jwtSecret)
  const func = 'hijack'

  beforeAll(async () => {
    relay = await runRelay(func, jwtSecret)
  })

  afterAll(async () => {
    if (relay) {
      await relay.stop()
    }
  })

  test('invoke func', async () => {
    /**
     * @feature hijack
     */
    log('create FunctionsClient')
    const fclient = new FunctionsClient(`http://localhost:${relay.container.getMappedPort(8081)}`, {
      headers: {
        Authorization: `Bearer ${apiKey}`,
      },
    })

    log('invoke func')
    const { data, error } = await fclient.invoke(func, {})

    log('assert error to be "Connection Upgrade is not supported"')
    expect(error).not.toBeNull()
  })
})
